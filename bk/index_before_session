<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Web Query Tool 查詢工具</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 2rem; background-color: #f8f9fa; color: #212529; display: flex; justify-content: center; }
        .container { max-width: 1200px; width: 100%; background: #ffffff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px-6px rgba(0, 0, 0, 0.1); }
        h3 { color: #0056b3; border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        .section { margin-bottom: 2rem; padding: 1.5rem; border: 1px solid #e9ecef; border-radius: 6px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-row { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        label { margin-bottom: 0.5rem; font-weight: 600; color: #495057; }
        input, select, textarea { width: 100%; padding: 0.5rem; box-sizing: border-box; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        textarea { resize: vertical; min-height: 200px; font-family: "Courier New", Courier, monospace; }
        
        button { background-color: #007bff; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s; white-space: nowrap; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        .format-btn { background-color: #6c757d; }
        .format-btn:hover:not(:disabled) { background-color: #5a6268; }
        .format-btn.active { background-color: #007bff; }
        .format-btn.active:hover:not(:disabled) { background-color: #0056b3; }

        .btn-success { background-color: #28a745; } .btn-success:hover:not(:disabled) { background-color: #218838; }
        .btn-danger { background-color: #dc3545; } .btn-danger:hover:not(:disabled) { background-color: #c82333; }
        .btn-info { background-color: #17a2b8; } .btn-info:hover:not(:disabled) { background-color: #138496; }
        .btn-secondary { background-color: #6c757d; } .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        
        .result-container { margin-top: 1rem; }
        .result-box { margin-top: 1rem; padding: 1rem; border-radius: 4px; font-family: "Courier New", Courier, monospace; word-wrap: break-word; max-height: 500px; overflow: auto; background-color: #e9ecef; border: 1px solid #ced4da; }
        .result-box.rowset-view { white-space: pre; overflow-x: auto; }
        .result-box.success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
        .result-box.error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
        
        table.clean-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        table.clean-table th, table.clean-table td { border: 1px solid #dee2e6; padding: 8px; text-align: left; vertical-align: top; }
        table.clean-table thead th { background-color: #f8f9fa; }
    </style>
</head>
<body>
<div class="container">
    <header class="text-center mb-8">
        <h1 style="text-align: center;" class="text-4xl font-bold text-gray-800">DB Web SQL Tool 查詢工具</h1>
    </header>
    <div class="section">
        <h3>
            <span>1. DB 連線設定</span>
                <div style="margin-left: auto;">
                    <select id="profiles-select" style="width: 200px;"><option value="">-- 新增設定檔 --</option></select>
                    <button id="save-profile-btn" class="btn-sm btn-success">儲存</button>
                    <button id="delete-profile-btn" class="btn-sm btn-danger">刪除</button>
                </div>
        </h3>
        <div class="form-row" style="justify-content: space-between;">
            <div class="form-grid" style="flex-grow: 1;">
                <div class="form-group"><label for="hostname">IP/Hostname</label><input type="text" id="hostname"></div>
                <div class="form-group"><label for="sid">SID</label><input type="text" id="sid"></div>
                <div class="form-group"><label for="user">帳號</label><input type="text" id="user"></div>
                <div class="form-group"><label for="password">密碼</label><input type="password" id="password"></div>
                <div class="form-group">
                    <label for="db-type">DB Type</label>
                    <select id="db-type">
                        <option value="ORA">Oracle</option>
                        <option value="SQL">MS-SQL Server</option>
                        <option value="POST">PostgreSQL</option>
                        <option value="LITE">SQLLite</option>
                    </select>
                </div>
                <div class="form-group"><label for="port">Port</label><input type="number" id="port"></div>
            </div>
        </div>
        <div class="form-row" style="margin-top: 1rem;">
            <button id="test-conn-btn">測試連線</button>
            <div id="conn-result" class="result-box" style="margin-top:0; padding: 0.5rem; display: none; flex-grow: 1;"></div>
        </div>
    </div>
    <div id="sql-section" class="section">
        <h3>
            <span>2. 執行 SQL Statement</span>
            <div class="form-row">
                <select id="sql-select" style="width: 200px;"><option value="">-- 新增 SQL --</option></select>
                <button id="save-sql-btn" class="btn-sm btn-success">儲存</button>
                <button id="delete-sql-btn" class="btn-sm btn-danger">刪除</button>
            </div>
        </h3>
        <textarea id="sql-statement" placeholder="例如：SELECT * FROM v$version"></textarea>
        <div class="form-row" style="margin-top: 1rem; justify-content: space-between;">
            <div class="form-row">
                <button id="request-query-btn">換頁查詢</button>
                <button id="execute-sql-btn" style="margin-left: 0.5rem;">同頁查詢</button>
                <button id="clear-sql-btn" class="btn-sm btn-secondary" style="margin-left: 0.5rem;">清除</button>
                <label for="max-rows" style="margin-left: 1rem; margin-bottom: 0;">Max Rows:</label>
                <input type="number" id="max-rows" value="200" style="width: 80px;">
            </div>
            <div id="format-controls">
                <button id="format-rowset" class="format-btn btn-sm">Row Set</button>
                <button id="format-datatables" class="format-btn btn-sm">DataTables</button>
                <button id="format-html" class="format-btn btn-sm">HTML Table</button>
                <button id="format-json" class="format-btn btn-sm">JSON</button>
                <button id="format-csv" class="btn-sm btn-success">Export CSV</button>
            </div>
        </div>
    </div>
    <div id="result-container" class="result-container"></div>
</div>

<!-- jQuery and DataTables JS -->
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let profiles = [];
    let sqls = [];
    let currentQueryResult = null;
    let execSqlStatement = ''; // 儲存當前頁面已執行的 SQL
    
    let activeFormat = 'rowset';
    let viewStates = {
        rowset: { isTransposed: false },
        html: { isRowSpan: false }
    };

    // --- DOM ELEMENTS ---
    const elements = {
        profileSelect: document.getElementById('profiles-select'),
        saveProfileBtn: document.getElementById('save-profile-btn'),
        deleteProfileBtn: document.getElementById('delete-profile-btn'),
        hostname: document.getElementById('hostname'),
        sid: document.getElementById('sid'),
        user: document.getElementById('user'),
        password: document.getElementById('password'),
        dbType: document.getElementById('db-type'),
        port: document.getElementById('port'),
        testConnBtn: document.getElementById('test-conn-btn'),
        connResult: document.getElementById('conn-result'),
        sqlSelect: document.getElementById('sql-select'),
        sqlStatement: document.getElementById('sql-statement'),
        saveSqlBtn: document.getElementById('save-sql-btn'),
        deleteSqlBtn: document.getElementById('delete-sql-btn'),
        executeSqlBtn: document.getElementById('execute-sql-btn'),
        requestQueryBtn: document.getElementById('request-query-btn'),
        clearSqlBtn: document.getElementById('clear-sql-btn'),
        maxRows: document.getElementById('max-rows'),
        formatControls: document.getElementById('format-controls'),
        resultContainer: document.getElementById('result-container'),
        sqlSection: document.getElementById('sql-section'),
    };

    // --- HELPER FUNCTIONS ---
    const apiCall = async (endpoint, method = 'GET', body = null) => {
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(endpoint, options);
        const result = await response.json();
        if (!response.ok) throw new Error(result.detail || 'An unknown error occurred.');
        return result;
    };

    const showConnResult = (message, isError) => {
        elements.connResult.style.display = 'block';
        elements.connResult.textContent = message;
        elements.connResult.className = 'result-box';
        elements.connResult.classList.add(isError ? 'error' : 'success');
    };

    const updateActiveFormatButton = () => {
        const buttons = elements.formatControls.querySelectorAll('.format-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(`format-${activeFormat}`);
        if (activeBtn) activeBtn.classList.add('active');
    };
    
    const setDefaultPort = () => {
        const dbType = elements.dbType.value;
        const defaultPorts = { 'ORA': 1521, 'SQL': 1433, 'POST': 5432, 'LITE': '' };
        elements.port.value = defaultPorts[dbType] || '';
    };

    const getStorageItem = (key) => JSON.parse(localStorage.getItem(key) || '[]');
    const setStorageItem = (key, value) => localStorage.setItem(key, JSON.stringify(value));
    
    const setLastUsedSql = (profileId, sqlId) => {
        if (!profileId) return;
        const lastUsedSqls = JSON.parse(localStorage.getItem('lastUsedSqlPerProfile')) || {};
        lastUsedSqls[profileId] = sqlId;
        localStorage.setItem('lastUsedSqlPerProfile', JSON.stringify(lastUsedSqls));
    };

    const getCredentials = () => ({
        hostname: elements.hostname.value.trim(),
        sid: elements.sid.value.trim(),
        user: elements.user.value.trim(),
        pwd: elements.password.value,
        db_type: elements.dbType.value,
        port: parseInt(elements.port.value) || null
    });
    
    const runQuery = async (queryData) => {
        elements.resultContainer.innerHTML = '<div class="result-box">查詢中...</div>';
        try {
            currentQueryResult = await apiCall('/execute-query', 'POST', queryData);
            execSqlStatement = queryData.sql; // 更新已執行的 SQL
            sessionStorage.setItem(window.location.search, JSON.stringify(currentQueryResult));
            viewStates.rowset.isTransposed = false;
            viewStates.html.isRowSpan = false;
            activeFormat = 'rowset';
            renderResult();
            elements.sqlSection.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            elements.resultContainer.innerHTML = `<div class="result-box error">查詢失敗: ${error.message}</div>`;
            currentQueryResult = null;
        }
    };

    // --- PROFILE & SQL MANAGEMENT (localStorage version) ---
    const loadProfiles = () => {
        profiles = getStorageItem('profiles');
        const selectedValue = elements.profileSelect.value;
        elements.profileSelect.innerHTML = '<option value="">-- 新增設定檔 --</option>';
        profiles.forEach(p => elements.profileSelect.add(new Option(p.name, p.id)));

        const lastProfileId = localStorage.getItem('lastProfileId');
        if (lastProfileId && elements.profileSelect.querySelector(`option[value="${lastProfileId}"]`)) {
            elements.profileSelect.value = lastProfileId;
        } else if (selectedValue && elements.profileSelect.querySelector(`option[value="${selectedValue}"]`)) {
            elements.profileSelect.value = selectedValue;
        }
        handleProfileChange();
    };

    const handleProfileChange = () => {
        const selectedId = elements.profileSelect.value;
        localStorage.setItem('lastProfileId', selectedId);

        if (selectedId) {
            const profile = profiles.find(p => p.id == selectedId);
            if (profile) {
                elements.hostname.value = profile.hostname || '';
                elements.sid.value = profile.sid || '';
                elements.user.value = profile.user || '';
                elements.password.value = profile.password || '';
                elements.dbType.value = profile.db_type || 'ORA';
                if (profile.port) {
                    elements.port.value = profile.port;
                } else {
                    setDefaultPort();
                }
            }
            loadSqls(selectedId);
        } else {
            ['hostname', 'sid', 'user', 'password'].forEach(id => elements[id].value = '');
            elements.dbType.value = 'ORA';
            setDefaultPort();
            loadSqls(null);
        }
    };

    const loadSqls = (profileId, autoSelect = true) => {
        sqls = getStorageItem('sqls');
        const selectedValue = elements.sqlSelect.value;
        elements.sqlSelect.innerHTML = '<option value="">-- 新增 SQL --</option>';
        if (profileId) {
            const profileSqls = sqls.filter(s => s.profile_id == profileId);
            profileSqls.forEach(s => elements.sqlSelect.add(new Option(s.name, s.id)));

            if (autoSelect) {
                const lastUsedSqls = JSON.parse(localStorage.getItem('lastUsedSqlPerProfile')) || {};
                const lastSqlIdForThisProfile = lastUsedSqls[profileId];

                if (lastSqlIdForThisProfile && elements.sqlSelect.querySelector(`option[value="${lastSqlIdForThisProfile}"]`)) {
                    elements.sqlSelect.value = lastSqlIdForThisProfile;
                } else if (selectedValue && elements.sqlSelect.querySelector(`option[value="${selectedValue}"]`)) {
                    elements.sqlSelect.value = selectedValue;
                }
            }
        }
        elements.sqlSelect.dispatchEvent(new Event('change'));
    };

    elements.saveProfileBtn.addEventListener('click', () => {
        profiles = getStorageItem('profiles');
        const selectedId = elements.profileSelect.value;
        const currentProfile = selectedId ? profiles.find(p => p.id == selectedId) : null;
        
        const promptTitle = "請輸入設定檔名稱：\n- 維持原有名稱可更新內容\n- 輸入新名稱則建立副本";
        const newName = prompt(promptTitle, currentProfile ? currentProfile.name : "");

        if (!newName) return;

        const profileData = {
            name: newName,
            hostname: elements.hostname.value.trim(), sid: elements.sid.value.trim(),
            user: elements.user.value.trim(), password: elements.password.value,
            db_type: elements.dbType.value, port: parseInt(elements.port.value) || null
        };
        
        if (currentProfile && newName === currentProfile.name) { // Update
            const profileIndex = profiles.findIndex(p => p.id == selectedId);
            profiles[profileIndex] = { ...currentProfile, ...profileData };
            setStorageItem('profiles', profiles);
            loadProfiles();
            elements.profileSelect.value = selectedId;
        } else { // Create new
            if (profiles.some(p => p.name === newName)) {
                return alert('此設定檔名稱已存在');
            }
            const newProfile = { ...profileData, id: Date.now().toString() };
            profiles.push(newProfile);
            setStorageItem('profiles', profiles);
            localStorage.setItem('lastProfileId', newProfile.id);
            loadProfiles();
        }
    });
    
    elements.deleteProfileBtn.addEventListener('click', () => {
        const selectedId = elements.profileSelect.value;
        if (!selectedId) return;

        const profileToDelete = getStorageItem('profiles').find(p => p.id == selectedId);
        if (!profileToDelete) return;
        
        if (confirm(`確定要刪除設定檔 '${profileToDelete.name}' 嗎？`)) {
            profiles = getStorageItem('profiles');
            const updatedProfiles = profiles.filter(p => p.id != selectedId);
            setStorageItem('profiles', updatedProfiles);

            sqls = getStorageItem('sqls');
            const updatedSqls = sqls.filter(s => s.profile_id != selectedId);
            setStorageItem('sqls', updatedSqls);

            loadProfiles();
        }
    });

    elements.saveSqlBtn.addEventListener('click', () => {
        const profileId = elements.profileSelect.value;
        if (!profileId) return alert('請先選擇一個資料庫設定檔');
        
        sqls = getStorageItem('sqls');
        const selectedSqlId = elements.sqlSelect.value;
        const currentSql = selectedSqlId ? sqls.find(s => s.id == selectedSqlId) : null;

        const promptTitle = "請輸入 SQL 名稱：\n- 維持原有名稱可更新內容\n- 輸入新名稱則建立副本";
        const newName = prompt(promptTitle, currentSql ? currentSql.name : "");
        
        if (!newName) return;

        const sqlData = {
            name: newName,
            statement: elements.sqlStatement.value.trim()
        };

        if (currentSql && newName === currentSql.name) { // Update
            const sqlIndex = sqls.findIndex(s => s.id == selectedSqlId);
            sqls[sqlIndex] = { ...currentSql, ...sqlData };
            setStorageItem('sqls', sqls);
            setLastUsedSql(profileId, currentSql.id);
            loadSqls(profileId);
            elements.sqlSelect.value = currentSql.id;
        } else { // Create
            if (sqls.some(s => s.profile_id == profileId && s.name === newName)) {
                return alert(`此設定檔下已有名為 '${newName}' 的 SQL`);
            }
            const newSql = { ...sqlData, id: Date.now().toString(), profile_id: profileId };
            sqls.push(newSql);
            setStorageItem('sqls', sqls);
            setLastUsedSql(profileId, newSql.id);
            loadSqls(profileId);
            elements.sqlSelect.value = newSql.id;
        }
    });

    elements.deleteSqlBtn.addEventListener('click', () => {
        const sqlId = elements.sqlSelect.value;
        if (!sqlId) return;
        
        const sqlToDelete = getStorageItem('sqls').find(s => s.id == sqlId);
        if (!sqlToDelete) return;

        if (confirm(`確定要刪除 SQL '${sqlToDelete.name}' 嗎？`)) {
            sqls = getStorageItem('sqls');
            const updatedSqls = sqls.filter(s => s.id != sqlId);
            setStorageItem('sqls', updatedSqls);

            const profileId = elements.profileSelect.value;
            setLastUsedSql(profileId, '');
            
            loadSqls(profileId);
        }
    });

    // --- DATABASE OPERATIONS (via Backend) ---
    elements.executeSqlBtn.addEventListener('click', async () => {
        const queryData = {
            ...getCredentials(),
            sql: elements.sqlStatement.value.trim(),
            max_rows: parseInt(elements.maxRows.value) || 200
        };
        runQuery(queryData);
    });

    elements.requestQueryBtn.addEventListener('click', () => {
        const sqlForRequest = elements.sqlStatement.value.trim();

        if (!sqlForRequest) {
            alert('請輸入 SQL 語句');
            return;
        }
        
        const credentials = getCredentials();
        const params = new URLSearchParams({
            ...credentials,
            sql: sqlForRequest,
            max_rows: elements.maxRows.value,
            profileId: elements.profileSelect.value
        });
        
        elements.sqlStatement.value = execSqlStatement;
        
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    });
    
    elements.clearSqlBtn.addEventListener('click', () => {
        if (elements.sqlStatement.value !== '') {
            elements.sqlStatement.value = '';
        } else {
            elements.sqlStatement.value = execSqlStatement;
        }
    });

    // --- RESULT FORMATTING ---
    const getTransposedData = (columns, data) => { 
        if (!columns || columns.length === 0 || !data || data.length === 0) return { headers: [], bodyRows: [] }; 
        const firstColumnName = columns[0]; 
        const newHeaders = [firstColumnName, ...data.map(row => row[firstColumnName] ?? '')]; 
        const newBodyRows = columns.slice(1).map(colName => { 
            const newRow = { [firstColumnName]: colName }; 
            data.forEach((originalRow, index) => { 
                const headerKey = newHeaders[index + 1]; 
                newRow[headerKey] = originalRow[colName] ?? ''; 
            }); 
            return newRow; 
        }); 
        return { headers: newHeaders, bodyRows: newBodyRows }; 
    };

    const renderResult = () => {
        if (!currentQueryResult) return;
        switch(activeFormat) {
            case 'rowset': renderRowSet(); break;
            case 'datatables': renderDataTables(); break;
            case 'html': renderHtmlTable(); break;
            case 'json': renderJson(); break;
        }
        updateActiveFormatButton();
    };

    const renderRowSet = () => { 
        const { columns, data } = currentQueryResult; 
        let text = `查詢成功，共回傳 ${data.length} 筆資料。\n\n`; 
        if (viewStates.rowset.isTransposed) { 
            const colWidths = columns.map(c => c.length); 
            data.forEach(row => columns.forEach((col, i) => { const val = String(row[col] ?? ''); if (val.length > colWidths[i]) colWidths[i] = val.length; })); 
            columns.forEach((col, i) => { text += col.padEnd(colWidths[i]) + ' | ' + data.map(row => String(row[col] ?? '').padEnd(colWidths[i])).join(' | ') + '\n'; }); 
        } else { 
            const colWidths = columns.map(c => c.length); 
            data.forEach(row => columns.forEach((col, i) => { const val = String(row[col] ?? ''); if (val.length > colWidths[i]) colWidths[i] = val.length; })); 
            text += columns.map((c, i) => c.padEnd(colWidths[i])).join(' | ') + '\n'; 
            text += columns.map((c, i) => '-'.repeat(colWidths[i])).join('-|-') + '\n'; 
            data.forEach(row => { text += columns.map((c, i) => String(row[c] ?? '').padEnd(colWidths[i])).join(' | ') + '\n'; }); 
        } 
        elements.resultContainer.innerHTML = `<pre class="result-box rowset-view">${text}</pre>`; 
    };
    const renderDataTables = () => { 
        const { columns, data } = currentQueryResult; 
        let headers, tableData; 
        if (viewStates.rowset.isTransposed) { 
            const transposed = getTransposedData(columns, data); 
            headers = transposed.headers; 
            tableData = transposed.bodyRows.map(row => headers.map(h => row[h])); 
        } else { 
            headers = columns; 
            tableData = data.map(row => columns.map(col => row[col])); 
        } 
        const tableId = `dt-${Date.now()}`; 
        elements.resultContainer.innerHTML = `<table id="${tableId}" class="display compact" style="width:100%"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead></table>`; 
        $(`#${tableId}`).DataTable({ data: tableData, destroy: true, scrollX: true }); 
    };
    const renderHtmlTable = () => { 
        const { columns, data } = currentQueryResult; 
        let headers, bodyRows; 
        if (viewStates.rowset.isTransposed) { 
            const transposed = getTransposedData(columns, data); 
            headers = transposed.headers; 
            bodyRows = transposed.bodyRows; 
        } else { 
            headers = columns; 
            bodyRows = data; 
        } 
        let tableHtml = '<table class="clean-table"><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>'; 
        if (viewStates.html.isRowSpan && !viewStates.rowset.isTransposed && bodyRows.length > 0) { 
            let lastValues = new Array(3).fill(null); 
            for (let i = 0; i < bodyRows.length; i++) { 
                tableHtml += '<tr>'; 
                for (let j = 0; j < headers.length; j++) { 
                    const col = headers[j]; 
                    const isSpanCol = j < 3; 
                    if (isSpanCol && i > 0 && bodyRows[i][col] === lastValues[j]) { 
                    } else { 
                        lastValues[j] = bodyRows[i][col]; 
                        let span = 1; 
                        if (isSpanCol) { 
                            for (let k = i + 1; k < bodyRows.length; k++) { 
                                if (bodyRows[k][col] === bodyRows[i][col]) span++; 
                                else break; 
                            } 
                        } 
                        tableHtml += `<td ${span > 1 ? `rowspan="${span}"` : ''}>${bodyRows[i][col] ?? ''}</td>`; 
                    } 
                } 
                tableHtml += '</tr>'; 
            } 
        } else { 
            bodyRows.forEach(row => { 
                tableHtml += '<tr>' + headers.map(col => `<td>${row[col] ?? ''}</td>`).join('') + '</tr>'; 
            }); 
        } 
        tableHtml += '</tbody></table>'; 
        elements.resultContainer.innerHTML = tableHtml; 
    };
    const renderJson = () => { 
        elements.resultContainer.innerHTML = `<pre class="result-box">${JSON.stringify(currentQueryResult.data, null, 2)}</pre>`; 
    };
    const exportCsv = () => { 
        const { columns, data } = currentQueryResult; 
        let headers, rows; 
        if (viewStates.rowset.isTransposed) { 
            const transposed = getTransposedData(columns, data); 
            headers = transposed.headers; 
            rows = transposed.bodyRows;
        } else { 
            headers = columns; 
            rows = data; 
        } 
        let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\r\n"; 
        rows.forEach(row => { csvContent += headers.map(header => `"${String(row[header] ?? '').replace(/"/g, '""')}"`).join(",") + "\r\n"; }); 
        const link = document.createElement("a"); 
        link.setAttribute("href", encodeURI(csvContent)); 
        link.setAttribute("download", "query_result.csv"); 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
    };

    // --- EVENT LISTENERS ---
    elements.profileSelect.addEventListener('change', handleProfileChange);
    
    elements.sqlSelect.addEventListener('change', () => {
        const profileId = elements.profileSelect.value;
        const sqlId = elements.sqlSelect.value;
        const sql = sqls.find(s => s.id == sqlId);
        if (sql) {
            elements.sqlStatement.value = sql.statement;
        }
        setLastUsedSql(profileId, sqlId);
    });
    
    elements.dbType.addEventListener('change', setDefaultPort);

    elements.testConnBtn.addEventListener('click', async () => {
        try {
            const result = await apiCall('/test-connection', 'POST', getCredentials());
            showConnResult(result.message, false);
        } catch (error) {
            showConnResult(error.message, true);
        }
    });

    elements.formatControls.addEventListener('click', (e) => {
        if (!e.target.matches('button')) return;
        if (!currentQueryResult) return;
        const targetId = e.target.id;
        switch(targetId) {
            case 'format-rowset':
                if (activeFormat === 'rowset') viewStates.rowset.isTransposed = !viewStates.rowset.isTransposed;
                activeFormat = 'rowset';
                break;
            case 'format-datatables':
                activeFormat = 'datatables';
                break;
            case 'format-html':
                if (activeFormat === 'html') viewStates.html.isRowSpan = !viewStates.html.isRowSpan;
                activeFormat = 'html';
                break;
            case 'format-json':
                activeFormat = 'json';
                break;
            case 'format-csv':
                exportCsv();
                return; 
        }
        renderResult();
    });

    // --- INITIALIZATION ---
    const urlParams = new URLSearchParams(window.location.search);
    const isResultPage = urlParams.has('sql');

    if (isResultPage) {
        document.title = "查詢結果";
        
        const queryData = {
            hostname: urlParams.get('hostname'), sid: urlParams.get('sid'),
            user: urlParams.get('user'), pwd: urlParams.get('pwd'),
            db_type: urlParams.get('db_type'), port: urlParams.get('port'),
            sql: urlParams.get('sql'), max_rows: urlParams.get('max_rows')
        };
        
        elements.hostname.value = queryData.hostname;
        elements.sid.value = queryData.sid;
        elements.user.value = queryData.user;
        elements.password.value = queryData.pwd;
        elements.dbType.value = queryData.db_type;
        elements.port.value = queryData.port;
        elements.sqlStatement.value = queryData.sql;
        elements.maxRows.value = queryData.max_rows;

        const cachedResultJSON = sessionStorage.getItem(window.location.search);
        if (cachedResultJSON) {
            currentQueryResult = JSON.parse(cachedResultJSON);
            execSqlStatement = queryData.sql;
            renderResult();
            elements.sqlSection.scrollIntoView({ behavior: 'smooth' });
        } else {
            runQuery(queryData);
        }
        
        profiles = getStorageItem('profiles');
        elements.profileSelect.innerHTML = '<option value="">-- 新增設定檔 --</option>';
        profiles.forEach(p => elements.profileSelect.add(new Option(p.name, p.id)));
        
        const profileId = urlParams.get('profileId');
        if (profileId) {
            elements.profileSelect.value = profileId;
            loadSqls(profileId, false); // 載入 SQL 但不自動選取
            elements.sqlSelect.value = ''; // 確保預設為 "-- 新增 SQL --"
        }
    } else {
        // This is the main page
        loadProfiles();
    }
});
</script>
</body>
</html>

